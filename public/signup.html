<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BankMaps – Signup</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f8fb;margin:0;padding:24px}
    .wrap{max-width:720px;margin:0 auto;background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:24px}
    h1{margin:0 0 12px;color:#0b3366}
    .field{margin:12px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,button{width:100%;padding:10px 12px;border:1px solid #ccd5e0;border-radius:10px;background:#fff}
    button{cursor:pointer;background:#0b5fff;color:#fff;border:0}
    button:disabled{opacity:.6;cursor:not-allowed}
    .note{color:#555;margin:6px 0 0 0;font-size:.9rem}
    .cards{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:16px}
    .card{background:#0b5fff;color:#fff;border-radius:12px;padding:14px;text-align:center;text-decoration:none}
    .error{color:#b00020;margin-top:8px}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BankMaps – Signup</h1>
    <p class="muted">Select your lender. We’ll show your percentile and Tier 1 payment options.</p>

    <div id="loadError" class="error" style="display:none;"></div>

    <div class="field">
      <label for="lenderSelect">Lender</label>
      <select id="lenderSelect">
        <option value="">— Select lender —</option>
      </select>
      <div id="lenderMeta" class="note"></div>
    </div>

    <div class="field">
      <button id="continueBtn" disabled>Continue</button>
      <div id="results" class="note"></div>
    </div>

    <div id="tierBlock" style="display:none;">
      <h3>Tier 1 – Choose a payment option</h3>
      <div class="cards">
        <a id="linkAnnualUpfront" class="card" target="_blank" rel="noopener">Annual — Pay in Full</a>
        <a id="linkAnnualMonthly" class="card" target="_blank" rel="noopener">Annual — Billed Monthly</a>
        <a id="linkMTM" class="card" target="_blank" rel="noopener">Month-to-Month</a>
      </div>
      <p class="note">After checkout you’ll be redirected to the login page.</p>
    </div>

    <p class="note">Uses cached lender rankings from the latest data year.</p>
  </div>

  <script>
  (async function(){
    const lenderUrl = '/public/loan_volume_cache.json';
    const tiersUrl  = '/public/tiers.config.json';

    const lenderSelect = document.getElementById('lenderSelect');
    const lenderMeta   = document.getElementById('lenderMeta');
    const continueBtn  = document.getElementById('continueBtn');
    const resultsEl    = document.getElementById('results');
    const tierBlock    = document.getElementById('tierBlock');
    const loadError    = document.getElementById('loadError');

    const linkAnnualUpfront = document.getElementById('linkAnnualUpfront');
    const linkAnnualMonthly = document.getElementById('linkAnnualMonthly');
    const linkMTM           = document.getElementById('linkMTM');

    let lenders = [], tiers = null;

    // Load lenders + tier links
    try {
      const [lr, tr] = await Promise.all([
        fetch(lenderUrl, { cache: 'no-store' }),
        fetch(tiersUrl,  { cache: 'no-store' })
      ]);
      if (!lr.ok || !tr.ok) throw new Error('Missing JSON files.');
      lenders = await lr.json();
      tiers   = await tr.json();
      if (!Array.isArray(lenders) || !tiers?.tiers?.tier1?.links) throw new Error('Invalid JSON shape.');
    } catch (e) {
      loadError.style.display = 'block';
      loadError.textContent = 'Error loading configuration. Please verify JSON files and refresh.';
      console.error('Load error:', e);
      return;
    }

    // Detect lender keys (robust to minor naming differences)
    const l0 = lenders[0] || {};
    const lenderIdKey   = ('lenderid'   in l0) ? 'lenderid'   : (('lender_id' in l0) ? 'lender_id' : 'lei');
    const lenderNameKey = ('lendername' in l0) ? 'lendername' : (('lender_name' in l0) ? 'lender_name' : lenderIdKey);

    // Populate lender dropdown
    lenders.sort((a,b)=> String(a[lenderNameKey]||'').localeCompare(String(b[lenderNameKey]||'')));
    for (const r of lenders) {
      const opt = document.createElement('option');
      opt.value = r[lenderIdKey];
      opt.textContent = r[lenderNameKey] || r[lenderIdKey];
      lenderSelect.appendChild(opt);
    }

    lenderSelect.addEventListener('change', () => {
      const r = lenders.find(x => String(x[lenderIdKey]) === String(lenderSelect.value));
      if (r) {
        const rc  = Number(r.record_count) || 0;
        const pct = Number(r.percentile)   || 0;
        lenderMeta.textContent = `Records: ${rc.toLocaleString()} • Percentile: ${pct.toFixed(2)}`;
        continueBtn.disabled = false;
      } else {
        lenderMeta.textContent = '';
        continueBtn.disabled = true;
      }
      tierBlock.style.display = 'none';
      resultsEl.textContent = '';
    });

    continueBtn.addEventListener('click', () => {
      const r = lenders.find(x => String(x[lenderIdKey]) === String(lenderSelect.value));
      if (!r) return;

      // Persist selection for login/provisioning status page (same-origin)
      try {
        localStorage.setItem('signup_lender', JSON.stringify({
          lenderid:   r[lenderIdKey],
          lendername: r[lenderNameKey],
          percentile: Number(r.percentile) || 0,
          record_count: Number(r.record_count) || 0,
          saved_at: new Date().toISOString()
        }));
      } catch {}

      resultsEl.textContent = `Selected: ${r[lenderNameKey] || r[lenderIdKey]} • Percentile ${Number(r.percentile||0).toFixed(2)}`;

      // Show Tier 1 links
      const t1 = tiers.tiers.tier1.links || {};
      linkAnnualUpfront.href = t1.annual_upfront || '#';
      linkAnnualMonthly.href = t1.annual_monthly || '#';
      linkMTM.href           = t1.month_to_month || '#';

      tierBlock.style.display = 'block';
      tierBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  })();
  </script>
</body>
</html>

