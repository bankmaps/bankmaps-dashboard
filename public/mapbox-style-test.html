<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mapbox Tileset Test (diagnostic)</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
  html,body {height:100%;margin:0}
  #top {position:fixed;z-index:2;top:8px;left:8px;background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.12);font:13px system-ui,Arial}
  #map {position:absolute;inset:0}
</style>
</head>
<body>
<div id="top"><strong>Status:</strong> <span id="s">Starting…</span></div>
<div id="map"></div>

<script>
(async () => {
  const s = (t) => document.getElementById('s').textContent = t;

  // Token
  let token = '';
  try { token = (await fetch('/api/mapbox-token').then(r=>r.json())).token || ''; } catch {}
  if (!token || !token.startsWith('pk.')) { s('Missing/invalid Mapbox token'); alert('Missing/invalid Mapbox token'); return; }
  mapboxgl.accessToken = token;

  // Your style + tileset info
  const STYLE = 'mapbox://styles/stuartmaps/cmhmpa5i4000s01ql6lrwh3tk';
  const SRC_ID = 'tracts2024';
  const SRC_URL = 'mapbox://stuartmaps.58y5r823';
  const LAYER = '2024-1pvgy8';

  const map = new mapboxgl.Map({ container:'map', style:STYLE, center:[-95,38.5], zoom:4 });
  map.addControl(new mapboxgl.NavigationControl(),'top-right');

  map.on('error', (e) => {
    console.error('Mapbox error:', e && e.error);
    alert('Mapbox error: ' + (e?.error?.message || JSON.stringify(e)));
  });

  await new Promise(res => map.once('styledata', res));
  await new Promise(res => map.once('idle', res));
  s('Style ready — adding source/layers…');

  // Add vector source and flat fill to prove rendering
  map.addSource(SRC_ID, { type:'vector', url:SRC_URL });
  map.addLayer({
    id: SRC_ID + '-testfill',
    type: 'fill',
    source: SRC_ID,
    'source-layer': LAYER,
    paint: { 'fill-color': '#a855f7', 'fill-opacity': 0.25 }
  });
  map.addLayer({
    id: SRC_ID + '-outline',
    type: 'line',
    source: SRC_ID,
    'source-layer': LAYER,
    paint: { 'line-color': '#000', 'line-width': 0.3, 'line-opacity': 0.4 }
  });

  // Count rendered features after a tick
  setTimeout(() => {
    const feats = map.queryRenderedFeatures({ layers:[SRC_ID + '-testfill'] });
    s(`Rendered features: ${feats.length}. Click a tract to inspect.`);
  }, 600);

  // Click to inspect a feature’s properties
  map.on('click', SRC_ID + '-testfill', (e) => {
    const f = e.features && e.features[0];
    if (!f) return;
    alert(`feature.id: ${f.id}\nGEOID prop: ${f.properties?.GEOID}`);
  });
})();
</script>
</body>
</html>
