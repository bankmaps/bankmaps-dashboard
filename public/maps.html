<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>BankMaps • Map</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
<style>
  body{margin:0;font-family:Arial,sans-serif;background:#f6f8fb}
  aside{position:fixed;top:16px;left:16px;z-index:2;background:#fff;padding:12px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08);width:300px}
  label{font-size:12px;color:#333}
  select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
  #map{position:fixed;top:0;left:0;right:0;bottom:0}
  #panel{position:fixed;right:16px;bottom:16px;z-index:2;background:#fff;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.08);max-height:40vh;overflow:auto;min-width:280px}
  #status{font-size:12px;color:#666;margin-top:6px}
</style>
</head>
<body>
<aside>
  <div><label>Lender</label>
    <select id="lender"></select>
  </div>
  <div id="status"></div>
</aside>
<div id="map"></div>
<div id="panel"><strong>Top Counties</strong><ol id="list"></ol></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
<script>
let map;
async function init(){
  // token
  const t = await fetch('/api/mapbox-token').then(r=>r.json());
  mapboxgl.accessToken = t.token || '';
  map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/light-v11', center: [-98.5, 39.8], zoom: 3.5 });

  // lenders
  const dd = document.getElementById('lender');
  const L = await fetch('/api/maps').then(r=>r.json()).catch(()=>({lenders:[]}));
  dd.innerHTML = L.lenders.map(name=>`<option>${name}</option>`).join('');
  dd.addEventListener('change', loadData);
  await loadData();
}

async function loadData(){
  const lender = document.getElementById('lender').value;
  const status = document.getElementById('status');
  const list = document.getElementById('list');
  status.textContent = 'Loading…';
  list.innerHTML = '';
  const res = await fetch('/api/map-data?lender='+encodeURIComponent(lender));
  if(!res.ok){ status.textContent = 'Error: ' + (await res.text()); return; }
  const data = await res.json();
  const rows = data.rows || [];
  status.textContent = rows.length ? '' : 'No data found.';

  // TODO: add county polygons/centroids and draw on the map.
  // For now, show a simple ranked list:
  list.innerHTML = rows.slice(0, 20).map(r=>`<li>${r.count} — ${r.county||'(no county)'}</li>`).join('');
}
init();
</script>
</body>
</html>
