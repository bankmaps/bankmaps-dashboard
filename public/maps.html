<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BankMaps â€¢ Tract Choropleth</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
  html,body,#map{height:100%;margin:0}
  body{font-family:Arial,sans-serif;background:#f6f8fb}
  #map{width:100%}
  aside{
    position:fixed;top:16px;left:16px;z-index:2;background:#fff;
    padding:12px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08);
    width:340px
  }
  label{font-size:12px;color:#333}
  select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-bottom:8px}
  #status{font-size:12px;color:#666;min-height:18px}
</style>
</head>
<body>
<div id="map"></div>

<aside>
  <label>Year</label>
  <select id="year"><option value="2024" selected>2024</option></select>

  <label>Lender</label>
  <select id="lender"></select>
  <div id="status">Loadingâ€¦</div>
</aside>

<script>
let map;
let prevIds = new Set();
let currentYear = "2024";

// ðŸ”¹ your exact custom Mapbox style
const MAP_STYLE = 'mapbox://styles/stuartmaps/cmhmpa5i4000s01ql6lrwh3tk';

// ðŸ”¹ your tileset info
const TILESETS = {
  "2024": { id: 'tracts2024', url: 'mapbox://stuartmaps.58y5r823', layer: '2024-1pvgy8' }
};

// color ramp
function choroplethPaint(){
  return {
    'fill-color': [
      'case',
      ['has', 'value', ['feature-state']],
      ['interpolate', ['linear'], ['to-number', ['feature-state', 'value']],
        1, '#e6f0ff',
        5, '#bcd6ff',
        20, '#85b8ff',
        50, '#589aff',
        100, '#256fd8',
        250, '#0f4ca3',
        500, '#002b73'
      ],
      'rgba(0,0,0,0)'
    ],
    'fill-opacity': ['case', ['has', 'value', ['feature-state']], 0.9, 0.15]
  };
}

async function init(){
  const status=document.getElementById('status');
  const { token } = await fetch('/api/mapbox-token').then(r=>r.json()).catch(()=>({token:''}));
  if(!token.startsWith('pk.')){ status.textContent='Invalid Mapbox token.'; return; }

  mapboxgl.accessToken = token;
  map = new mapboxgl.Map({
    container:'map',
    style: MAP_STYLE,
    center:[-95, 38.5],
    zoom:4.2
  });
  map.addControl(new mapboxgl.NavigationControl(),'top-right');

  // ðŸ”¹ Wait for style fully loaded
  await new Promise(res => map.once('styledata', res));
  await new Promise(res => map.once('idle', res));
  status.textContent = 'Map style ready.';

  // persist lender
  const savedLender = localStorage.getItem('selectedLender');

  const dd=document.getElementById('lender');
  const L=await fetch('/api/maps').then(r=>r.json()).catch(()=>({lenders:[]}));
  dd.innerHTML=(L.lenders||[]).map(n=>`<option>${n}</option>`).join('');
  if(savedLender && L.lenders.includes(savedLender)) dd.value = savedLender;
  dd.addEventListener('change',()=>{
    localStorage.setItem('selectedLender',dd.value);
    loadCounts();
  });

  await updateTileset();
  await loadCounts();
}

async function updateTileset(){
  const t=TILESETS[currentYear];
  const status=document.getElementById('status');
  if(!t){ status.textContent=`No tileset for ${currentYear}`; return; }

  // clear any existing
  if(map.getLayer(t.id+'-choropleth')) map.removeLayer(t.id+'-choropleth');
  if(map.getLayer(t.id+'-outline')) map.removeLayer(t.id+'-outline');
  if(map.getSource(t.id)) map.removeSource(t.id);

  map.addSource(t.id,{type:'vector',url:t.url,promoteId:'GEOID'});

  map.addLayer({
    id:t.id+'-choropleth',
    type:'fill',
    source:t.id,
    'source-layer':t.layer,
    paint:choroplethPaint()
  });
  map.addLayer({
    id:t.id+'-outline',
    type:'line',
    source:t.id,
    'source-layer':t.layer,
    paint:{'line-color':'#000','line-width':0.4,'line-opacity':0.35}
  });

  map.on('click',t.id+'-choropleth',(e)=>{
    if(!e.features.length) return;
    const f=e.features[0];
    const st=map.getFeatureState({source:t.id,'sourceLayer':t.layer,id:f.id});
    alert(`GEOID: ${f.properties.GEOID}\nValue(state): ${JSON.stringify(st)}`);
  });

  // force visible immediately
  map.resize();
  map.triggerRepaint();
  status.textContent='Tileset loaded.';
}

async function loadCounts(){
  const lender=document.getElementById('lender').value;
  const status=document.getElementById('status');
  const t=TILESETS[currentYear];
  if(!t){ status.textContent=`No tileset for ${currentYear}`; return; }

  const res=await fetch(`/api/map-data-tracts?lender=${encodeURIComponent(lender)}&year=${currentYear}`);
  if(!res.ok){ status.textContent='Error: '+(await res.text()); return; }

  const data=await res.json();
  const rows=data.rows||[];
  const counts=new Map(rows.map(r=>[String(r.GEOID),r.count]));
  status.textContent=`Loaded ${counts.size} tracts. Coloringâ€¦`;

  for(const id of prevIds){
    map.setFeatureState({source:t.id,'sourceLayer':t.layer,id},{value:null});
  }
  prevIds.clear();

  for(const [geoid,val] of counts.entries()){
    map.setFeatureState({source:t.id,'sourceLayer':t.layer,id:geoid},{value:val});
    prevIds.add(geoid);
  }

  map.triggerRepaint();
  status.textContent=`Colored ${counts.size} tracts.`;
}

init();
</script>
</body>
</html>
