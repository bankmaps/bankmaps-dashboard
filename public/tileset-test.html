<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tileset Test (no API, no filters)</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
  html,body{height:100%;margin:0}
  #map{position:fixed;inset:0}
  #status{position:fixed;left:12px;top:12px;background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.08);font:13px/1.3 system-ui}
</style>
</head>
<body>
<div id="map"></div>
<div id="status">Loadingâ€¦</div>
<script>
(async function(){
  // ---- config: ONLY change these if your tileset/layer changes ----
  const STYLE_URL   = 'mapbox://styles/mapbox/light-v11';               // neutral base
  const TILESET_URL = 'mapbox://stuartmaps.58y5r823';                   // your tileset
  const LAYER_NAME  = '2024-1pvgy8';                                    // your layer name
  const PROMOTE_KEY = 'GEOID';                                          // feature id property
  // -----------------------------------------------------------------

  const status = document.getElementById('status');

  // fetch token
  const tokResp = await fetch('/api/mapbox-token').catch(()=>null);
  const tokJson = tokResp && tokResp.ok ? await tokResp.json() : {token:''};
  const token = tokJson.token || '';
  if(!token || !token.startsWith('pk.')){ status.textContent = 'Mapbox token missing/invalid.'; return; }

  mapboxgl.accessToken = token;
  const map = new mapboxgl.Map({ container:'map', style: STYLE_URL, center:[-98.5,39.8], zoom:3.5 });
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');
  map.on('error', e => { status.textContent = 'Map error: ' + (e?.error?.message || JSON.stringify(e)); });
  await new Promise(res => map.once('load', res));

  // add your vector source (promote GEOID as id)
  map.addSource('tracts_src', { type:'vector', url:TILESET_URL, promoteId:PROMOTE_KEY });

  // big obvious styling so we SEE it
  map.addLayer({
    id:'tracts_fill',
    type:'fill',
    source:'tracts_src',
    'source-layer': LAYER_NAME,
    paint:{ 'fill-color':'#ff00ff', 'fill-opacity':0.25 }
  });
  map.addLayer({
    id:'tracts_outline',
    type:'line',
    source:'tracts_src',
    'source-layer': LAYER_NAME,
    paint:{ 'line-color':'#000', 'line-width':1.0, 'line-opacity':0.9 }
  });

  // count rendered features (quick sanity check)
  const count = map.queryRenderedFeatures({ layers:['tracts_fill'] }).length;
  status.textContent = 'Rendered features: ' + count + '  (click a tract to inspect)';

  // click to inspect properties (confirm GEOID exists)
  map.on('click', 'tracts_fill', (e) => {
    const f = e.features && e.features[0];
    if (f) alert(JSON.stringify(f.properties, null, 2));
  });
})();
</script>
</body>
</html>
