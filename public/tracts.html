<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>BankMaps • Tract Choropleth (2024)</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
  html,body{height:100%;margin:0}
  body{font-family:Arial,sans-serif;background:#f6f8fb}
  #map{position:fixed;inset:0;width:100vw;height:100vh}
  aside{
    position:fixed;top:16px;left:16px;z-index:2;background:#fff;
    padding:12px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08);
    width:340px
  }
  label{font-size:12px;color:#333}
  select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-bottom:8px}
  #status{font-size:12px;color:#666;min-height:18px}
</style>
</head>
<body>
<div id="map"></div>

<aside>
  <label>Lender</label>
  <select id="lender"></select>
  <div id="status">Loading…</div>
</aside>

<script>
let map;
let counts = new Map();

function colorRampExpr() {
  // Color scale based on feature-state value
  return [
    'interpolate', ['linear'], ['coalesce', ['to-number', ['feature-state', 'value']], 0],
    0,  '#f0f4ff',
    5,  '#c8d8ff',
    20, '#91b4ff',
    50, '#5f90f6',
    100,'#2b6ce3',
    250,'#174db6',
    500,'#0b3366'
  ];
}

async function init(){
  const status = document.getElementById('status');
  const { token } = await fetch('/api/mapbox-token').then(r=>r.json()).catch(()=>({token:''}));
  if(!token || !token.startsWith('pk.')) {
    status.textContent='Mapbox token missing or invalid.';
    return;
  }

  mapboxgl.accessToken = token;
  map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/light-v11',
    center:[-98.5,39.8],
    zoom:3.5
  });
  map.addControl(new mapboxgl.NavigationControl(),'top-right');
  await new Promise(res => map.once('load', res));

  // --- Add your 2024 tileset source ---
  map.addSource('tracts2024', {
    type: 'vector',
    url: 'mapbox://stuartmaps.58y5r823'
  });

  // --- Add layers (fill + outline) ---
  map.addLayer({
    id:'tracts-fill',
    type:'fill',
    source:'tracts2024',
    'source-layer':'2024-1pvgy8',   // your actual layer name
    paint:{
      'fill-color': colorRampExpr(),
      'fill-opacity': 0.75
    }
  });
  map.addLayer({
    id:'tracts-outline',
    type:'line',
    source:'tracts2024',
    'source-layer':'2024-1pvgy8',
    paint:{'line-color':'#ffffff','line-width':0.3,'line-opacity':0.6}
  });

  // --- Populate lender dropdown ---
  const dd = document.getElementById('lender');
  const L = await fetch('/api/maps').then(r=>r.json()).catch(()=>({lenders:[]}));
  dd.innerHTML = (L.lenders||[]).map(n=>`<option>${n}</option>`).join('');
  dd.addEventListener('change', loadCounts);

  await loadCounts(); // first load
}

async function loadCounts(){
  const lender = document.getElementById('lender').value;
  const status = document.getElementById('status');
  status.textContent = 'Loading counts…';

  const res = await fetch(`/api/map-data-tracts?lender=${encodeURIComponent(lender)}&year=2024`);
  if(!res.ok){ status.textContent = 'Error: '+(await res.text()); return; }
  const data = await res.json();
  counts = new Map((data.rows||[]).map(r => [String(r.geoid), r.count]));

  status.textContent = `Loaded ${counts.size} tracts. Coloring…`;
  applyCounts();
  status.textContent = '';
}

function applyCounts(){
  // Apply counts to map features via feature-state
  for (const [geoid, value] of counts.entries()) {
    map.setFeatureState(
      { source: 'tracts2024', sourceLayer: '2024-1pvgy8', id: geoid },
      { value }
    );
  }
}

init();
</script>
</body>
</html>
