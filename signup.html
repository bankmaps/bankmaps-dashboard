<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BankMaps – Signup (MVP)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f8fb;margin:0;padding:24px}
    .wrap{max-width:860px;margin:0 auto;background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:24px}
    h1{margin:0 0 12px;color:#0b3366}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .field{margin:12px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,button{width:100%;padding:10px 12px;border:1px solid #ccd5e0;border-radius:10px;background:#fff}
    button{cursor:pointer;background:#0b5fff;color:#fff;border:0}
    button:disabled{opacity:.6;cursor:not-allowed}
    .note{color:#555;margin:6px 0 0 0;font-size:.9rem}
    .pill{display:inline-block;background:#eef3ff;color:#0b3366;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:.85rem}
    .cards{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:16px}
    .card{background:#0b5fff;color:#fff;border-radius:12px;padding:14px;text-align:center;text-decoration:none}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BankMaps – Signup</h1>
    <p class="muted">Pick your lender and market. We’ll calculate percentiles and show Tier 1 payment options.</p>

    <div class="field">
      <label for="lenderSelect">Lender</label>
      <select id="lenderSelect">
        <option value="">— Select lender —</option>
      </select>
      <div id="lenderMeta" class="note"></div>
    </div>

    <div class="row">
      <div class="field">
        <label for="stateSelect">State</label>
        <select id="stateSelect">
          <option value="">— Select state —</option>
        </select>
      </div>
      <div class="field">
        <label for="countySelect">Counties (hold Ctrl/⌘ for multi-select)</label>
        <select id="countySelect" multiple size="8"></select>
        <div id="countyChips"></div>
      </div>
    </div>

    <div class="field">
      <button id="calcBtn" disabled>Calculate Percentiles</button>
      <div id="results" class="note"></div>
    </div>

    <div id="tierBlock" style="display:none;">
      <h3>Tier 1 – Choose a payment option</h3>
      <div class="cards">
        <a id="linkAnnualUpfront" class="card" target="_blank" rel="noopener">Annual — Pay in Full</a>
        <a id="linkAnnualMonthly" class="card" target="_blank" rel="noopener">Annual — Billed Monthly</a>
        <a id="linkMTM" class="card" target="_blank" rel="noopener">Month-to-Month</a>
      </div>
      <p class="note">After checkout you’ll be redirected to the login page.</p>
    </div>

    <p class="note">Data sources: cached lender and geo rankings from latest year.</p>
  </div>

  <script>
  (async function(){
    const lenderUrl = '/include/cache/loan_volume_cache.json';
    const geoUrl = '/include/cache/peer_geo_cache.json';
    const tiersUrl = '/include/tiers.config.json';

    const lenderSelect = document.getElementById('lenderSelect');
    const stateSelect  = document.getElementById('stateSelect');
    const countySelect = document.getElementById('countySelect');
    const calcBtn      = document.getElementById('calcBtn');
    const lenderMeta   = document.getElementById('lenderMeta');
    const countyChips  = document.getElementById('countyChips');
    const resultsEl    = document.getElementById('results');
    const tierBlock    = document.getElementById('tierBlock');

    const linkAnnualUpfront = document.getElementById('linkAnnualUpfront');
    const linkAnnualMonthly = document.getElementById('linkAnnualMonthly');
    const linkMTM           = document.getElementById('linkMTM');

    let lenders = [];
    let geos = [];
    let tiers = null;

    // Fetch all three JSONs
    try {
      const [lendersRes, geosRes, tiersRes] = await Promise.all([
        fetch(lenderUrl, { cache: 'no-store' }),
        fetch(geoUrl, { cache: 'no-store' }),
        fetch(tiersUrl, { cache: 'no-store' })
      ]);
      if (!lendersRes.ok || !geosRes.ok || !tiersRes.ok) throw new Error('Failed to fetch one or more configuration files.');

      lenders = await lendersRes.json();
      geos    = await geosRes.json();
      tiers   = await tiersRes.json();
    } catch (e) {
      resultsEl.textContent = 'Error loading configuration. Please refresh.';
      console.error(e);
      return;
    }

    // Populate lender dropdown (sorted by lendername)
    lenders.sort((a,b)=> (a.lendername||'').localeCompare(b.lendername||''));
    for (const r of lenders) {
      const opt = document.createElement('option');
      opt.value = r.lenderid;
      opt.textContent = r.lendername || r.lenderid;
      lenderSelect.appendChild(opt);
    }

    // Build state list from geos
    const states = Array.from(new Set(geos.map(g => g.statename))).sort((a,b)=>a.localeCompare(b));
    for (const s of states) {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      stateSelect.appendChild(opt);
    }

    function refreshCountyList() {
      countySelect.innerHTML = '';
      countyChips.innerHTML = '';
      const s = stateSelect.value;
      if (!s) return;
      const counties = geos.filter(g => g.statename === s)
                           .map(g => g.county)
                           .filter(Boolean);
      const unique = Array.from(new Set(counties)).sort((a,b)=>a.localeCompare(b));
      for (const c of unique) {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        countySelect.appendChild(opt);
      }
    }

    stateSelect.addEventListener('change', () => {
      refreshCountyList();
      calcBtn.disabled = !(lenderSelect.value && stateSelect.value);
    });

    lenderSelect.addEventListener('change', () => {
      const r = lenders.find(x => String(x.lenderid) === String(lenderSelect.value));
      if (r) {
        lenderMeta.textContent = `Records: ${r.record_count.toLocaleString()}  •  Percentile: ${Number(r.percentile).toFixed(2)}`;
      } else {
        lenderMeta.textContent = '';
      }
      calcBtn.disabled = !(lenderSelect.value && stateSelect.value);
    });

    countySelect.addEventListener('change', () => {
      countyChips.innerHTML = '';
      const sel = Array.from(countySelect.selectedOptions).map(o=>o.value);
      for (const c of sel) {
        const span = document.createElement('span');
        span.className='pill';
        span.textContent = c;
        countyChips.appendChild(span);
      }
    });

    function percentileFromSum(sumCount, baseArray) {
      // Percentile of sumCount vs distribution of single-county counts (approximation for MVP)
      const counts = baseArray.map(x => Number(x.record_count) || 0);
      const belowOrEqual = counts.filter(v => v <= sumCount).length;
      return (belowOrEqual / counts.length) * 100;
    }

    calcBtn.addEventListener('click', () => {
      tierBlock.style.display = 'none';
      resultsEl.textContent = '';

      const lenderId = lenderSelect.value;
      const lenderRow = lenders.find(x => String(x.lenderid) === String(lenderId));
      if (!lenderRow) {
        resultsEl.textContent = 'Please select a lender.';
        return;
      }

      const state = stateSelect.value;
      const selectedCounties = Array.from(countySelect.selectedOptions).map(o=>o.value);
      const countyRows = geos.filter(g => g.statename === state && (selectedCounties.length===0 || selectedCounties.includes(g.county)));

      // Sum record_count across selected counties (union). If none selected, treat as whole state.
      const peerRows = (selectedCounties.length ? countyRows : geos.filter(g=>g.statename===state));
      const peerCountSum = peerRows.reduce((acc,g)=> acc + (Number(g.record_count)||0), 0);

      // Approx percentile vs all counties (MVP). We can refine later.
      const peerPercentile = percentileFromSum(peerCountSum, geos);

      const lenderPct = Number(lenderRow.percentile) || 0;
      resultsEl.textContent = `Lender percentile: ${lenderPct.toFixed(2)} • Peer percentile (approx.): ${peerPercentile.toFixed(2)} • Peer records: ${peerCountSum.toLocaleString()}`;

      // For now, always Tier 1 (you’ll tune the rule later)
      const t1 = tiers?.tiers?.tier1?.links || {};
      const params = new URLSearchParams({
        lenderid: String(lenderRow.lenderid || ''),
        lendername: String(lenderRow.lendername || ''),
        lender_pct: lenderPct.toFixed(2),
        state,
        counties: selectedCounties.join('|'),
        peer_pct: peerPercentile.toFixed(2),
        peer_records: String(peerCountSum)
      }).toString();

      // Attach params so you can inspect after redirect (Stripe won’t forward them; this is just for transparency if needed)
      linkAnnualUpfront.href = (t1.annual_upfront || '#') + '';
      linkAnnualMonthly.href = (t1.annual_monthly || '#') + '';
      linkMTM.href           = (t1.month_to_month || '#') + '';

      tierBlock.style.display = 'block';
      tierBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Prefill links (disabled until calculation)
    const t1 = tiers?.tiers?.tier1?.links || {};
    linkAnnualUpfront.href = t1.annual_upfront || '#';
    linkAnnualMonthly.href = t1.annual_monthly || '#';
    linkMTM.href           = t1.month_to_month || '#';
  })();
  </script>
</body>
</html>

