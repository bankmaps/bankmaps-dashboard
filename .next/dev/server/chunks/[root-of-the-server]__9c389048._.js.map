{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///c:/ai/bankmaps/app/api/ask/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { neon } from '@neondatabase/serverless';\r\nimport { drizzle } from 'drizzle-orm/neon-http';\r\nimport Groq from 'groq-sdk';\r\nimport { sql } from 'drizzle-orm';\r\n\r\n// Singleton Groq client (good practice)\r\nconst groq = new Groq({ apiKey: process.env.GROQ_API_KEY });\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { question } = await req.json();\r\n\r\n    if (!question || typeof question !== 'string' || !question.trim()) {\r\n      return NextResponse.json({ error: 'Missing or invalid question' }, { status: 400 });\r\n    }\r\n\r\n    const questionText = question.trim();\r\n\r\n    // Step 1: Extract keywords with a tiny/fast model\r\n    const rewrite = await groq.chat.completions.create({\r\n      model: 'llama-3.1-8b-instant', // keep small & fast here\r\n      temperature: 0.1,\r\n      max_tokens: 60,\r\n      messages: [\r\n        {\r\n          role: 'system',\r\n          content: 'Convert the question into a simple list of search keywords separated by spaces. Return ONLY the keywords, nothing else. Example: \"bank account types\" → \"bank account types\"',\r\n        },\r\n        { role: 'user', content: questionText },\r\n      ],\r\n    });\r\n\r\n    const keywordsRaw = rewrite.choices?.[0]?.message?.content?.trim() || questionText;\r\n    const keywordList = keywordsRaw.split(/\\s+/).filter(Boolean);\r\n\r\n    if (keywordList.length === 0) {\r\n      return NextResponse.json({ answer: 'No valid search terms.' });\r\n    }\r\n\r\n    // Step 2: Database connection (per-request is fine for Neon HTTP)\r\n    const conn = neon(process.env.NEON_DATABASE_URL!);\r\n    const db = drizzle(conn);\r\n\r\n    // Better: use Drizzle query builder instead of raw sql for safety/readability\r\n    const results = await db.execute(sql`\r\n      SELECT chunk_text AS content\r\n      FROM pdf_chunks\r\n      WHERE ${keywordList\r\n        .map((k) => sql`chunk_text ILIKE ${`%${k}%`}`)\r\n        .reduce((acc, cond) => sql`${acc} OR ${cond}`, sql`FALSE`)}\r\n      LIMIT 10;  -- increased a bit; adjust as needed\r\n    `);\r\n\r\n    if (results.rows.length === 0) {\r\n      return NextResponse.json({ answer: 'No relevant information found in your documents.' });\r\n    }\r\n\r\n    const context = results.rows.map((r: { content: string }) => r.content).join('\\n\\n---\\n\\n');\r\n\r\n    // Step 3: Generate answer with stronger model + better system prompt\r\n    const answerRes = await groq.chat.completions.create({\r\n      model: 'llama-3.3-70b-versatile', // ← upgrade this for better answers\r\n      temperature: 0.4,                 // slightly higher for natural language\r\n      max_tokens: 800,\r\n      messages: [\r\n        {\r\n          role: 'system',\r\n          content: `You are a helpful assistant answering questions about documents (especially banking/maps related).\r\nUse ONLY the provided context below to answer.\r\nBe concise, accurate, natural, and structured.\r\nUse Markdown: **bold** for emphasis, - bullets for lists, headings if needed.\r\nIf the context doesn't contain the answer, reply exactly: \"No relevant information found in the documents.\"\r\n\r\nContext:\r\n${context}`,\r\n        },\r\n        { role: 'user', content: questionText },\r\n      ],\r\n    });\r\n\r\n    const answer = answerRes.choices?.[0]?.message?.content?.trim() || 'No answer generated';\r\n\r\n    return NextResponse.json({ answer });\r\n  } catch (err: any) {\r\n    console.error('Chat API error:', {\r\n      message: err.message,\r\n      stack: err.stack,\r\n      question: req.body ? await req.json().then(b => b.question).catch(() => 'unknown') : 'unknown',\r\n    });\r\n    return NextResponse.json({ error: err.message || 'Server error' }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEA,wCAAwC;AACxC,MAAM,OAAO,IAAI,kKAAI,CAAC;IAAE,QAAQ,QAAQ,GAAG,CAAC,YAAY;AAAC;AAElD,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QAEnC,IAAI,CAAC,YAAY,OAAO,aAAa,YAAY,CAAC,SAAS,IAAI,IAAI;YACjE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA8B,GAAG;gBAAE,QAAQ;YAAI;QACnF;QAEA,MAAM,eAAe,SAAS,IAAI;QAElC,kDAAkD;QAClD,MAAM,UAAU,MAAM,KAAK,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACjD,OAAO;YACP,aAAa;YACb,YAAY;YACZ,UAAU;gBACR;oBACE,MAAM;oBACN,SAAS;gBACX;gBACA;oBAAE,MAAM;oBAAQ,SAAS;gBAAa;aACvC;QACH;QAEA,MAAM,cAAc,QAAQ,OAAO,EAAE,CAAC,EAAE,EAAE,SAAS,SAAS,UAAU;QACtE,MAAM,cAAc,YAAY,KAAK,CAAC,OAAO,MAAM,CAAC;QAEpD,IAAI,YAAY,MAAM,KAAK,GAAG;YAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,QAAQ;YAAyB;QAC9D;QAEA,kEAAkE;QAClE,MAAM,OAAO,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,iBAAiB;QAC/C,MAAM,KAAK,IAAA,qKAAO,EAAC;QAEnB,8EAA8E;QAC9E,MAAM,UAAU,MAAM,GAAG,OAAO,CAAC,qJAAG,CAAC;;;YAG7B,EAAE,YACL,GAAG,CAAC,CAAC,IAAM,qJAAG,CAAC,iBAAiB,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC,EAC5C,MAAM,CAAC,CAAC,KAAK,OAAS,qJAAG,CAAC,EAAE,IAAI,IAAI,EAAE,KAAK,CAAC,EAAE,qJAAG,CAAC,KAAK,CAAC,EAAE;;IAE/D,CAAC;QAED,IAAI,QAAQ,IAAI,CAAC,MAAM,KAAK,GAAG;YAC7B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,QAAQ;YAAmD;QACxF;QAEA,MAAM,UAAU,QAAQ,IAAI,CAAC,GAAG,CAAC,CAAC,IAA2B,EAAE,OAAO,EAAE,IAAI,CAAC;QAE7E,qEAAqE;QACrE,MAAM,YAAY,MAAM,KAAK,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACnD,OAAO;YACP,aAAa;YACb,YAAY;YACZ,UAAU;gBACR;oBACE,MAAM;oBACN,SAAS,CAAC;;;;;;;AAOpB,EAAE,SAAS;gBACH;gBACA;oBAAE,MAAM;oBAAQ,SAAS;gBAAa;aACvC;QACH;QAEA,MAAM,SAAS,UAAU,OAAO,EAAE,CAAC,EAAE,EAAE,SAAS,SAAS,UAAU;QAEnE,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAO;IACpC,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,mBAAmB;YAC/B,SAAS,IAAI,OAAO;YACpB,OAAO,IAAI,KAAK;YAChB,UAAU,IAAI,IAAI,GAAG,MAAM,IAAI,IAAI,GAAG,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,EAAE,KAAK,CAAC,IAAM,aAAa;QACvF;QACA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO,IAAI;QAAe,GAAG;YAAE,QAAQ;QAAI;IACnF;AACF"}}]
}